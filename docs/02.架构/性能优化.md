关于性能优化问题，可以从以下方面去谈：讲述一下自己做性能优化相关工作的经验、以及对于性能优化工作的一些理论的理解，比如就包括：性能优化的衡量指标，期间需要注意的问题等等。

## 衡量指标

对于性能优化来说，衡量的指标有很多，大体上可以分为：性能指标、响应时间、并发量、秒开率和正确性等。我们可以使用下图来表示这些衡量指标。

![图片](http://img.yluchao.cn/typora/d1f357fb7bae748a03c24105f1a294f7.webp)

接下来，我们就分别说明下这些衡量指标。

### 性能指标

性能指标又可以包含：吞吐量和响应速度。我们平时所说的QPS、TPS和HPS等，就可以归结为吞吐量。有很多小伙伴可能对于QPS、TPS和HPS等不太了解，我们先来说下这几个字母的含义。

- QPS代表的是每秒的查询数量。
- TPS代表的是每秒事务的数量。
- HPS代表的是每秒的HTTP请求数量。

这些都是与吞吐量相关的衡量指标。

平时我们在做优化工作的时候，首先要明确需要优化的事项。比如：我们做的优化工作是要提高系统的吞吐量？还是要提升系统的响应速度呢？举一个具体点的例子：比如我们的程序中存在一些数据库或者缓存的批量操作，虽然在数据的读取上，响应速度下降了，但是我们优化的目标就是吞吐量，只要我们优化后系统的整体吞吐量明显上升了，那这也是提升了程序的性能。

**所以说，优化性能不只是提升系统的响应速度。**

这里，优化性能也并不是一味的优化吞吐量和优化响应速度，而是在吞吐量和响应速度之间找到一个平衡点，使用有限的服务器资源来更好的提升用户体验。

### 响应时间

对于响应时间来说，有两个非常重要的衡量指标。那就是：**平均响应时间和百分位数。**

**（1）平均响应时间**

通常，平均响应时间体现的是服务接口的平均处理能力。计算方式就是把所有的请求所耗费的时间加起来，然后除以请求的次数。举个简单的例子：比如：我们向一个网站发送了5次请求，每次请求所耗费的时间分别为：1ms，2ms，1ms，3ms，2ms，那么，平均响应时间就是（1+2+1+3+2）/ 5 = 1.8ms，所以，平均响应时间就是1.8ms。

平均响应时间这个指标存在一个问题：如果在短时间内请求变得很慢，但很快过去了，此时使用平均响应时间就无法很好的体现出性能的波动问题。

**（2）百分位数**

百分位数就是我们在优化的时候，圈定一个时间范围，把每次请求的耗时加入一个列表中，然后按照从小到大的顺序将这些时间进行排序。这样，我们取出特定百分位的耗时，这个数字就是 TP 值。

TP值表示的含义就是：超过 N% 的请求都在 X 时间内返回。比如 TP90 = 50ms，意思是超过 90th 的请求，都在 50ms 内返回。

百分位数这个指标也是很重要的，它反映的是应用接口的整体响应情况。

我们一般会将百分位数分为 TP50、TP90、TP95、TP99、TP99.9 等多个段，对高百分位的值要求越高，对系统响应能力的稳定性要求越高。

### 并发量

并发量指的是系统能够同时处理的请求数量，反映的是系统的负载能力。

我们在对高并发系统进行优化的时候，往往也会在并发量上进行调优，调优方式也是多种多样的，目的就是提高系统同时处理请求的能力。

总体来说，并发量这个指标理解起来还是比较简单的，我就不做过多的描述了。

### 秒开率

秒开率主要针对的是前端网页或者移动端APP来说的，如果一个前端网页或者APP能够在1秒内很平滑的打开，尤其是首页的加载。此时，用户就会感到前端网页或者APP使用起来很顺畅，如果超过3秒甚至更长的时间，用户就有可能会直接退出前端网页或者APP不再使用。

所以，在高并发场景下优化程序，不只要对后端程序进行优化，对于前端和APP也是要进行优化的。

### 正确性

正确性说的是无论我们以何种方式，何种手段对应用进行优化，优化后的交互数据结果必须是正确的。不能出现优化前性能比较低，数据正确，而优化后性能比较高，反而数据不正确的现象。

## 优化需要注意的问题

![图片](http://img.yluchao.cn/typora/187fd2d9f0f886f293fd68992f5d8e35.webp)

- 除非必要,一开始不要优化(尤其是开发阶段)
- 有些优化准则已经过时,需要考虑当下的软硬件环境(不要墨守成规)
- 不要过分强调某些系统级指标,如cache 命中率,而应该聚焦性能瓶颈点
- 不盲从，测试、找到系统的性能瓶颈，再确定优化手段
- 注意权衡优化的成本和收益（有些优化可能需要现有架构做出调整、增加开发/运维成本）
- 优化的目标是用户体验、降低硬件成本（降低集群规模、不依赖单机高性能）
- 测试环境的优化手段未必对生产环境有效（优化需要针对真实情况）



# 具体优化方法

​		我们可以从数据聚合优化、资源冲突优化、算法优化、JVM优化、复用优化、计算优化和快速实现等方面来进行回答。接下来，我们就针对每个点进行说明。

### 1. 数据聚合优化

数据聚合优化主要针对的是对于数据的整合和传输的优化。比如：我们从数据库中查询出的数据，经过程序的聚合处理后再返回给客户端，而不用客户端调用多次接口来分别获取数据。

再比如：我们在项目中使用的Nginx，一般都会开启GZIP压缩，使传输的数据更加紧凑，同时，使传输的数据量更小。

细心的小伙伴会发现，我们对于数据聚合的优化，主要是使传输的数据量更小。所以，我们在使用SQL语句查询数据库中的数据时，尽量查询那些需要的字段，对于不需要的字段就直接忽略不查询了，避免在SQL语句中出现select *

### 2. 资源冲突优化

在我们平时的工作中，尤其是在高并发的场景下，经常会出现锁冲突的问题，锁冲突是资源冲突的一个典型场景。

关于锁我们可以联想到数据库的行锁、表锁、Java中的synchronized和Lock等。如果对应到操作系统级别，则会有CPU命令级别的锁，JVM指令级别的锁，操作系统的内部锁等。

这里，小伙伴们需要注意一点：只有在并发的场景下，才会出现资源冲突的问题。也就是说：在同一时刻，只能有一个请求获取到请求资源，解决冲突的方式就是加锁。

我们需要在平时的工作过程中避免锁冲突的问题，优化如何优化加锁方式，小伙伴们可以参见《[【高并发】面试官：讲讲高并发场景下如何优化加锁方式？](https://mp.weixin.qq.com/s?__biz=Mzg3MzE1NTIzNA==&mid=2247488569&idx=1&sn=b9e1e60bee2166e3043695a9198b67d1&chksm=cee50bf4f99282e2eb7b69196eebf65d02260cdc151cd3aa7d639abb0afa9bcf30dd6e485939&token=537906095&lang=zh_CN&scene=21#wechat_redirect)》一文。

### 3. 算法优化（程序优化）

在一个大型的互联网项目中，往往涉及到分布式和微服务等技术，其中，也会使用到大量的数据结构和算法，对于算法的优化能够显著的提高系统的性能。一个好的实现，相比于一个拙劣的实现来说，在系统性能的提升上存在着巨大的差异。

比如，作为 List 的实现，LinkedList 和 ArrayList 在随机访问的性能上，差了好几个数量级；又比如，CopyOnWriteList 采用写时复制的方式，可以显著降低读多写少场景下的锁冲突。而什么时候使用同步，什么时候是线程安全的，也对我们的编码能力有较高的要求。

所以，我们需要在平时工作过程中，多多积累数据结构和算法的相关知识。

### 4. 软件优化（php-fpm）



### 5. 复用优化

复用优化，这个看名字就知道，说白了就是可以重复利用。估计很多小伙伴都有这样的经验，在写代码的时候，可以将很多重复的代码抽象出来，做成公共的方法。这样，就不用每次都去写重复的逻辑代码了。这是代码层面的复用。

如果是数据层面的话，我们可以使用缓冲和缓存来复用数据。

这里，小伙伴们需要注意一个知识点：缓冲主要针对的是写操作，缓存主要针对的是读操作。

另一个复用优化的典型场景就是池化技术，比如：数据库连接池、线程池等。

### 6. 计算优化

对于计算优化来说，我们可以从以下几个小的方面来阐述。

1. **并行计算**

    不难理解，就是多个计算同时进行。这里，又可以将并行计算分为：多机并行计算、多进程并行计算和多线程并行计算。

2. **多机并行计算：** 将一个大的计算任务，拆分成N个小的计算任务，分发到不同的机器进行处理。典型的场景就是Hadoop的MapReduce极端。

3. **多进程计算：** 比如，Nginx采用的NIO模型，采用的是进程调度的策略，由Master进程调度Worker进程，Worker进行来处理具体的请求。

4. **多线程计算**：对于多线程计算来说，也是我们平时接触最多的一种计算方式，我们可以使用多线程技术，将复杂的逻辑计算拆分成一个个小的计算任务，分发到不同的线程中去执行。

5. **同步变异步**

    同步和异步的区别就是：同步需要等待返回结果，异步不需要等待返回结果。如果我们在业务程序中，不需要等待返回结果数据，则我们可以将同步调用优化为异步调用，从而提升我们系统的性能。

6. **懒加载**

    最典型的场景就是Spring中的懒加载，只有第一次获取bean的时候，才会创建bean实例。

### 7. 快速实现

对于快速实现来说，不仅包含我们需要利用相关的程序框架迅速开发出我们想要的业务，也需要我们在进行技术选型时，尽量使用一些性能优良的组件。

很多公司喜欢使用适配器模式，在一些现有的开源组件之上，再抽象一层自己的组件，这样就能够做到切换底层组件的时候，对上层应用无感。